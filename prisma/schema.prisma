generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ======================================
// ENUMS
// ======================================

enum StockMovementType {
  IN
  OUT
  ADJUSTMENT
  RETURN
}

enum SaleStatus {
  PENDING
  COMPLETED
  CANCELED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  TRANSFER
  CHECK
}

enum PermissionKey {
  CREATE_SALE
  CANCEL_SALE
  VIEW_SALES
  MANAGE_PRODUCTS
  MANAGE_STOCK
  OPEN_CASH
  CLOSE_CASH
  VIEW_REPORTS
  MANAGE_USERS
}

enum CashSessionStatus {
  OPEN
  CLOSED
  ARCHIVED // For historical data migration
}

enum PrinterConnectionType {
  TCP_IP
  USB_SERIAL
}

enum PaperWidth {
  MM80
  MM58
}

// ======================================
// AUTH & RBAC
// ======================================

model User {
  id                    String  @id @default(uuid())
  email                 String  @unique
  name                  String?
  password              String
  requirePasswordChange Boolean @default(false)
  active                Boolean @default(true)

  roleId String
  role   Role   @relation(fields: [roleId], references: [id])

  sales         Sale[]
  sessions      CashSession[]
  cashMovements CashMovement[] @relation("CashMovementCreator")

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([roleId])
  @@index([deletedAt])
}

model Role {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?

  users       User[]
  permissions RolePermission[]
}

model Permission {
  id    String        @id @default(uuid())
  key   PermissionKey @unique
  label String

  roles RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

// ======================================
// PRODUCTS
// ======================================

model ProductCategory {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  products    Product[]
}

// ======================================
// VARIANT ATTRIBUTES
// ======================================

model AttributeTemplate {
  id           String  @id @default(uuid())
  name         String  @unique // "Size", "Color", "Material"
  description  String?
  displayOrder Int     @default(0)
  active       Boolean @default(true)

  options AttributeOption[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
  @@index([displayOrder])
}

model AttributeOption {
  id           String  @id @default(uuid())
  templateId   String
  value        String // "Small", "Red", "Cotton"
  displayOrder Int     @default(0)
  active       Boolean @default(true)

  template          AttributeTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  variantAttributes VariantAttribute[]

  createdAt DateTime @default(now())

  @@unique([templateId, value])
  @@index([templateId])
  @@index([active])
}

model VariantAttribute {
  id        String @id @default(uuid())
  variantId String
  optionId  String

  variant ProductVariant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  option  AttributeOption @relation(fields: [optionId], references: [id], onDelete: Restrict)

  @@unique([variantId, optionId])
  @@index([variantId])
  @@index([optionId])
}

model Product {
  id          String           @id @default(uuid())
  name        String
  description String?
  categoryId  String?
  category    ProductCategory? @relation(fields: [categoryId], references: [id])

  imageUrl      String? // Full Cloudinary URL for display
  imagePublicId String? // Cloudinary public_id for deletion

  variants ProductVariant[]

  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([name])
  @@index([categoryId])
  @@index([deletedAt])
  @@index([imagePublicId])
  @@index([deletedAt, active]) // Composite index for common filter queries
  @@index([createdAt]) // For ordering by date
}

model ProductVariant {
  id        String  @id @default(uuid())
  productId String
  sku       String  @unique
  name      String? // KEEP for backward compatibility

  // NEW FIELDS for variant attributes
  imageUrl      String? // Variant-specific image
  imagePublicId String? // Cloudinary public_id for deletion
  displayName   String? // "Medium / Red" - denormalized for performance

  price     Decimal @db.Decimal(10, 2)
  costPrice Decimal @db.Decimal(10, 2)

  product    Product            @relation(fields: [productId], references: [id])
  stock      Stock?
  saleItems  SaleItem[]
  movements  StockMovement[]
  attributes VariantAttribute[] // NEW RELATION

  @@index([productId])
  @@index([sku]) // For SKU search optimization
  @@index([imagePublicId])
  @@index([displayName]) // For search/filtering
}

// ======================================
// INVENTORY
// ======================================

model Stock {
  id               String @id @default(uuid())
  productVariantId String @unique
  quantity         Int    @default(0)
  minimumStock     Int    @default(0)

  variant ProductVariant @relation(fields: [productVariantId], references: [id])

  updatedAt DateTime @updatedAt

  @@index([minimumStock])
}

model StockMovement {
  id               String            @id @default(uuid())
  productVariantId String
  type             StockMovementType
  quantity         Int
  reason           String?

  variant ProductVariant @relation(fields: [productVariantId], references: [id])

  saleItemId String?
  saleItem   SaleItem? @relation(fields: [saleItemId], references: [id])

  createdAt DateTime @default(now())

  @@index([productVariantId])
  @@index([saleItemId])
  @@index([type])
  @@index([createdAt])
}

// ======================================
// CUSTOMERS
// ======================================

model Customer {
  id               String  @id @default(uuid())
  firstName        String
  lastName         String
  email            String? @unique
  phone            String?
  address          String?
  dni              String? @unique
  membershipNumber String? @unique

  sales Sale[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([email])
  @@index([phone])
  @@index([firstName])
  @@index([lastName])
  @@index([dni])
  @@index([membershipNumber])
  @@index([deletedAt])
  @@index([createdAt])
}

// ======================================
// SALES
// ======================================

model Sale {
  id     String     @id @default(uuid())
  status SaleStatus @default(COMPLETED)

  sessionId String?
  session   CashSession? @relation(fields: [sessionId], references: [id])

  userId     String
  customerId String?

  subtotal  Decimal  @db.Decimal(10, 2)
  tax       Decimal  @default(0) @db.Decimal(10, 2)
  discount  Decimal  @default(0) @db.Decimal(10, 2)
  total     Decimal  @db.Decimal(10, 2)
  totalCost Decimal? @db.Decimal(10, 2)

  user     User      @relation(fields: [userId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])

  items    SaleItem[]
  payments Payment[]

  // NEW: Link to cash movements for automatic SALE/REFUND tracking
  cashMovements CashMovement[]

  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([sessionId])
  @@index([userId])
  @@index([customerId])
  @@index([status])
  @@index([userId, status])
}

// ======================================
// SALE ITEMS
// ======================================

model SaleItem {
  id               String @id @default(uuid())
  saleId           String
  productVariantId String
  quantity         Int

  priceAtSale Decimal @db.Decimal(10, 2)
  costAtSale  Decimal @db.Decimal(10, 2)

  sale           Sale            @relation(fields: [saleId], references: [id], onDelete: Cascade)
  variant        ProductVariant  @relation(fields: [productVariantId], references: [id])
  stockMovements StockMovement[]

  @@index([saleId])
  @@index([productVariantId])
}

// ======================================
// PAYMENTS
// ======================================

model Payment {
  id     String        @id @default(uuid())
  saleId String
  method PaymentMethod
  amount Decimal       @db.Decimal(10, 2)

  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([saleId])
  @@index([method])
}

// ======================================
// CASH MANAGEMENT
// ======================================

model CashRegister {
  id     String  @id @default(uuid())
  name   String
  active Boolean @default(true)

  sessions CashSession[]
  printers Printer[]
}

model Printer {
  id                String                @id @default(uuid())
  name              String
  description       String?
  model             String?
  connectionType    PrinterConnectionType
  ipAddress         String?               // TCP_IP only
  systemPrinterName String?               // USB_SERIAL only (exact Windows printer name)
  paperWidth        PaperWidth            @default(MM80)
  autoPrint         Boolean               @default(false)
  active            Boolean               @default(true)
  cashRegisterId    String?               // optional â€” some businesses have no printer
  cashRegister      CashRegister?         @relation(fields: [cashRegisterId], references: [id])
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  deletedAt         DateTime?

  @@index([cashRegisterId])
  @@index([active])
  @@index([deletedAt])
}

model CashSession {
  id             String @id @default(uuid())
  cashRegisterId String
  userId         String

  // NEW: Explicit status field (more reliable than nullable closedAt)
  status CashSessionStatus @default(OPEN)

  openingAmount Decimal @db.Decimal(10, 2)

  // Closing amounts per payment method (all-methods verification requirement)
  closingAmountCash       Decimal? @db.Decimal(10, 2)
  closingAmountCreditCard Decimal? @db.Decimal(10, 2)
  closingAmountDebitCard  Decimal? @db.Decimal(10, 2)
  closingAmountTransfer   Decimal? @db.Decimal(10, 2)
  closingAmountCheck      Decimal? @db.Decimal(10, 2)
  // REMOVED: closingAmountOther (unused field)

  // Expected amounts per payment method (calculated from movements)
  expectedAmountCash       Decimal? @db.Decimal(10, 2)
  expectedAmountCreditCard Decimal? @db.Decimal(10, 2)
  expectedAmountDebitCard  Decimal? @db.Decimal(10, 2)
  expectedAmountTransfer   Decimal? @db.Decimal(10, 2)
  expectedAmountCheck      Decimal? @db.Decimal(10, 2)
  // REMOVED: expectedAmountOther (unused field)

  // Differences per payment method (closing - expected)
  differenceCash       Decimal? @db.Decimal(10, 2)
  differenceCreditCard Decimal? @db.Decimal(10, 2)
  differenceDebitCard  Decimal? @db.Decimal(10, 2)
  differenceTransfer   Decimal? @db.Decimal(10, 2)
  differenceCheck      Decimal? @db.Decimal(10, 2)
  // REMOVED: differenceOther (unused field)

  // Backwards compatibility - sum of all payment methods
  closingAmount  Decimal? @db.Decimal(10, 2)
  expectedAmount Decimal? @db.Decimal(10, 2)
  difference     Decimal? @db.Decimal(10, 2)

  openedAt     DateTime  @default(now())
  closedAt     DateTime?
  closingNotes String?

  cashRegister CashRegister   @relation(fields: [cashRegisterId], references: [id])
  user         User           @relation(fields: [userId], references: [id])
  sales        Sale[]
  movements    CashMovement[]

  @@index([cashRegisterId])
  @@index([userId])
  @@index([openedAt])
  @@index([closedAt])
  @@index([status])
  @@index([cashRegisterId, status])
}

enum CashMovementType {
  INCOME // Manual cash in (replaces DEPOSIT)
  EXPENSE // Manual cash out (replaces WITHDRAWAL/EXPENSE)
  SALE // Automatic from sale completion
  REFUND // Automatic from sale cancellation/refund

  // DEPRECATED - kept for migration compatibility
  OPENING // Will be archived
  CLOSING // Will be archived
  DEPOSIT // Will be archived
  WITHDRAWAL // Will be archived
  ADJUSTMENT // Will be archived
}

model CashMovement {
  id            String           @id @default(uuid())
  sessionId     String
  type          CashMovementType
  paymentMethod PaymentMethod    @default(CASH)
  amount        Decimal          @db.Decimal(10, 2)
  description   String?

  // NEW: Link to sales for automatic SALE/REFUND movements
  saleId String?

  // Audit trail: track who created the movement
  createdBy String

  session CashSession @relation(fields: [sessionId], references: [id])
  sale    Sale?       @relation(fields: [saleId], references: [id])
  creator User        @relation("CashMovementCreator", fields: [createdBy], references: [id])

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([type])
  @@index([createdAt])
  @@index([paymentMethod])
  @@index([saleId])
  @@index([createdBy])
}
